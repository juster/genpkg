#!/bin/sh

prog=genpkg

metad=~/.genpkg/metas
templd=~/.genpkg/templ
tweakd=~/pkg/tweaks
pkgd=~/pkg/dest
vard=~/.genpkg/var

if [ $# -lt 1 ]
then
	echo "usage: $prog [package name]" 1>&2
	exit 2
fi

if ! [ -d "$tweakd" ]
then
	echo "$prog: bad package tweaks dir: $tweakd" 1>&2
	exit 1
fi

if ! [ -d "$pkgd" ]
then
	echo "$prog: bad package dest dir: $pkgd" 1>&2
	exit 1
fi

if ! [ -d "$vard" ]
then
	echo "$prog: bad package var dir: $vard" 1>&2
	exit 1
fi

cwd=$(pwd)

for pkg
do
	[ -d "$pkgd/$pkg" ] || mkdir "$pkgd/$pkg"
	cd "$pkgd/$pkg"

	if METABIN="$metad" PKGVAR="$vard" mkpkgmeta "$pkg"
	then
		echo "$pkgd/$pkg"
		echo "Generated PKGDATA and PKGTREE." 1>&2
	else
		exit $?
	fi

	twk="$tweakd/$pkg"
	if [ -f "$twk" -a -r "$twk" ] && modpkgmeta
	then
		echo "Modified metapackage." 1>&2
	fi

	mergepbfields | emitpkgtree || exit $?
done

