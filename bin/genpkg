#!/bin/sh

prog=genpkg

metad=~/.genpkg/metas
templd=~/.genpkg/templ
tweakd=~/pkg/tweaks
pkgd=~/pkg/dest
vard=~/.genpkg/var

if [ $# -lt 1 ]
then
	echo "usage: $prog [package name]" 1>&2
	exit 2
fi

if ! [ -d "$tweakd" ]
then
	echo "$prog: bad package tweaks dir: $tweakd" 1>&2
	exit 1
fi

if ! [ -d "$pkgd" ]
then
	echo "$prog: bad package dest dir: $pkgd" 1>&2
	exit 1
fi

if ! [ -d "$vard" ]
then
	echo "$prog: bad package var dir: $vard" 1>&2
	exit 1
fi

cwd=$(pwd)

for pkg
do
	[ -d "$pkgd/$pkg" ] || mkdir "$pkgd/$pkg"
	cd "$pkgd/$pkg"

	echo "$pkgd/$pkg"
	if METABIN="$metad" PKGVAR="$vard" mkpkgdata "$pkg" > PKGDATA
	then
		echo "Generated PKGDATA."
	else
		exit $?
	fi

	twk="$tweakd/$pkg"
	if [ -f "$twk" -a -r "$twk" ]
	then
		if ! tweakmeta < "$twk" > PKGDATA.new
		then
			echo "$prog: tweakmeta returned error: $?" 1>&2
			rm PKGDATA.new
			exit 1
		fi
		mv PKGDATA.new PKGDATA
		echo "Tweaked PKGDATA with $twk."
	fi

	if TDIR="$templd" mkpkgbuild 
	then
		echo "Generated PKGBUILD."
	else
		exit $?
	fi
done
