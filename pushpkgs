#!/bin/sh

prependid()
{
	sed -e '/^#/!{
	i\
\# $Id$
	:loop
	n
	b loop
	}' PKGBUILD >PKGBUILD.new
	mv PKGBUILD.new PKGBUILD
}

# Make sure that the package directories are added to the SVN repo.
syncsvn()
{
	svn add --parents PKGBUILD ../repos
	# Make sure that the Id keyword-property is active.
	svn propset svn:keywords Id PKGBUILD
}


if [ -z "$REPODIR" ]
then
	echo "Specify the destination directory with the REPODIR env var." 1>&2
	exit 1
fi

[ "$PKGDEST" ] || PKGDEST=~/pkg/dest

cd "$PKGDEST" || exit $?
pkgdir=$(pwd)

for pkg
do
	if [ ! -d "$pkg" ]
	then
		echo "pkg/$pkg was not found." 1>&2
		continue
	fi

	echo "$REPODIR/$pkg"
	if [ -d "$REPODIR/$pkg" ]
	then
		rm -rf "$REPODIR/$pkg/trunk/"*
	fi

	mkdir -p "$REPODIR/$pkg/"{trunk,repos}
	cp -r -t "$REPODIR/$pkg/trunk" "$pkg"/* 

	cd "$REPODIR/$pkg/trunk"
	prependid
	syncsvn >/dev/null 2>&1

	cd "$pkgdir"
done
